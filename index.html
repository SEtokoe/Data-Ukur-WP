<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pengukuran Beda Tinggi</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background: #fff;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        p {
            text-align: center;
            color: #666;
        }
        fieldset {
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 6px;
        }
        legend {
            font-weight: bold;
            font-size: 1.2em;
            color: #555;
            padding: 0 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #444;
        }
        input[type="text"], input[type="date"], input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* Allow wrapping for smaller screens */
        }
        .btn-group button {
            flex: 1;
            margin: 0;
            min-width: 150px; /* Ensure buttons don't get too small */
        }
        .hidden {
            display: none;
        }
        .point-entry {
            border: 1px solid #ccc;
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
            background-color: #f9f9f9;
            position: relative;
        }
        .remove-point-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 0.8em;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 10px;
            width: auto;
            margin: 0;
        }
        .remove-point-btn:hover {
            background-color: #c82333;
        }
        .add-point-btn {
            background-color: #28a745;
        }
        .add-point-btn:hover {
            background-color: #218838;
        }
        /* Style untuk halaman review */
        .review-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .review-section h2 {
            margin-top: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        #cross-section-plot {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
            background-color: #fff;
            margin-top: 10px;
        }
        .sta-list {
            list-style: none;
            padding: 0;
        }
        .sta-list li {
            background-color: #e9ecef;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sta-list li button {
            width: auto;
            margin: 0;
            padding: 5px 10px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

    <div id="page1" class="container">
        <h1>Aplikasi Pengukuran Beda Tinggi</h1>
        <p>Isi informasi proyek dan surveyor untuk memulai.</p>
        <form id="project-form">
            <fieldset>
                <legend>Informasi Proyek & Surveyor</legend>
                <div class="form-group">
                    <label for="surveyor">Surveyor:</label>
                    <input type="text" id="surveyor" name="surveyor" required>
                </div>
                <div class="form-group">
                    <label for="tanggal_pengukuran">Tanggal Pengukuran:</label>
                    <input type="date" id="tanggal_pengukuran" name="tanggal_pengukuran" required>
                </div>
                <div class="form-group">
                    <label for="lokasi_proyek">Lokasi Proyek:</label>
                    <select id="lokasi_proyek" name="lokasi_proyek" required>
                        <option value="">-- Pilih Lokasi Proyek --</option>
                        <option value="D.I.R. Sukaraja">D.I.R. Sukaraja</option>
                        <option value="D.I.R. Doros">D.I.R. Doros</option>
                        <option value="D.I.R. Mulyaguna">D.I.R. Mulyaguna</option>
                        <option value="D.I.R. Sukapulih">D.I.R. Sukapulih</option>
                        <option value="D.I.R. Pulau Gemantung">D.I.R. Pulau Gemantung</option>
                        <option value="D.I.R. Tanjung Beringin Trans">D.I.R. Tanjung Beringin Trans</option>
                        <option value="D.I.R. Talang Cempedak">D.I.R. Talang Cempedak</option>
                        <option value="D.I.R. Tanjung Serang">D.I.R. Tanjung Serang</option>
                        <option value="D.I.R. Ulak Jermun">D.I.R. Ulak Jermun</option>
                        <option value="D.I.R. Sidomulyo">D.I.R. Sidomulyo</option>
                        <option value="D.I.R. Kayu Labu">D.I.R. Kayu Labu</option>
                        <option value="D.I.R. Sungai Jeruju">D.I.R. Sungai Jeruju</option>
                        <option value="D.I.R. Balam Jeruju">D.I.R. Balam Jeruju</option>
                        <option value="D.I.R. Adil Makmur">D.I.R. Adil Makmur</option>
                        <option value="D.I.R. Sungai Ketupak">D.I.R. Sungai Ketupak</option>
                        <option value="D.I.R. Gajah Mukti">D.I.R. Gajah Mukti</option>
                        <option value="D.I.R. Dewa Sibur">D.I.R. Dewa Sibur</option>
                        <option value="D.I.R. Nata Sibur">D.I.R. Nata Sibur</option>
                        <option value="D.I.R. Lebak Semendawai">D.I.R. Lebak Semendawai</option>
                        <option value="D.I.R. Adumanis">D.I.R. Adumanis</option>
                        <option value="D.I.R. Lebak Tobong">D.I.R. Lebak Tobong</option>
                        <option value="D.I.R. Lebak Datuk">D.I.R. Lebak Datuk</option>
                        <option value="D.I.R. Serudung">D.I.R. Serudung</option>
                        <option value="D.I.R. Sungai Ulak Baru">D.I.R. Sungai Ulak Baru</option>
                        <option value="D.I.R. Arisan Musi Timur">D.I.R. Arisan Musi Timur</option>
                        <option value="D.I.R. Arisan Musi">D.I.R. Arisan Musi</option>
                        <option value="D.I. Sungai Jerami">D.I. Sungai Jerami</option>
                        <option value="D.I.R. Lingkis">D.I.R. Lingkis</option>
                        <option value="D.I.R. Gedung Buruk">D.I.R. Gedung Buruk</option>
                        <option value="D.I.R. Tanjung Sejaro">D.I.R. Tanjung Sejaro</option>
                        <option value="D.I.R. Siring Alam">D.I.R. Siring Alam</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="item_pekerjaan">Item Pekerjaan/Area:</label>
                    <input type="text" id="item_pekerjaan" name="item_pekerjaan" required>
                </div>
                <div class="form-group">
                    <label for="kondisi_cuaca">Kondisi Cuaca:</label>
                    <select id="kondisi_cuaca" name="kondisi_cuaca">
                        <option value="">-- Pilih Cuaca --</option>
                        <option value="Cerah">Cerah</option>
                        <option value="Mendung">Mendung</option>
                        <option value="Gerimis">Gerimis</option>
                        <option value="Hujan Sedang">Hujan Sedang</option>
                        <option value="Hujan Lebat">Hujan Lebat</option>
                    </select>
                </div>
            </fieldset>
            <button type="submit">Lanjutkan ke Set Up STA</button>
            <hr>
            <div class="form-group">
                <label for="load-data-file">Atau muat data yang sudah ada (JSON):</label>
                <input type="file" id="load-data-file" accept=".json">
            </div>
        </form>
    </div>

    <div id="page2" class="container hidden">
        <h1>Aplikasi Pengukuran Beda Tinggi</h1>
        <p>Isi detail Set Up Alat (STA) untuk memulai pengukuran.</p>
        <form id="sta-form">
            <fieldset>
                <legend>Set Up Alat & STA</legend>
                <div class="form-group">
                    <label for="alat_waterpass">Alat Waterpass:</label>
                    <input type="text" id="alat_waterpass" name="alat_waterpass">
                </div>
                <div class="form-group">
                    <label for="nomor_seri_alat">Nomor Seri Alat:</label>
                    <input type="text" id="nomor_seri_alat" name="nomor_seri_alat">
                </div>
                <div class="form-group">
                    <label for="titik_berdiri_alat_sta">Titik Berdiri Alat (STA):</label>
                    <input type="text" id="titik_berdiri_alat_sta" name="titik_berdiri_alat_sta" required>
                </div>
                <div class="form-group">
                    <label for="bm_ttp">BM/TTP:</label>
                    <input type="text" id="bm_ttp" name="bm_ttp" required>
                </div>
                <div class="form-group">
                    <label for="bs">Bacaan Rambu Backsight (BS):</label>
                    <input type="number" id="bs" name="bs" step="0.001" required>
                </div>
                <div class="form-group">
                    <label for="elevasi_bm_ttp">Elevasi BM/TTP:</label>
                    <input type="number" id="elevasi_bm_ttp" name="elevasi_bm_ttp" step="0.001" required>
                </div>
                <div class="form-group">
                    <label>Calculated HI:</label>
                    <input type="text" id="calculated_hi" readonly>
                </div>
            </fieldset>
            <button type="submit" id="start-points-btn">Mulai Input Titik Target</button>
            <button type="button" id="back-to-page1" class="btn-secondary">Kembali ke Info Proyek</button>
        </form>
    </div>

    <div id="page3" class="container hidden">
        <h1>Input Titik Target <span id="current-sta-name"></span></h1>
        <p>Tambahkan titik target untuk STA ini.</p>
        <form id="points-form">
            <div id="points-container">
            </div>
            <button type="button" id="add-point-btn" class="add-point-btn">+ Tambah Titik</button>
            <button type="submit" id="save-sta-btn">Selesaikan STA Ini</button>
            <button type="button" id="back-to-page2" class="btn-secondary">Kembali ke Set Up STA</button>
        </form>
    </div>

    <div id="page4" class="container hidden">
        <h1>Ringkasan Proyek</h1>
        <p>Proyek: <strong id="review-project-name"></strong></p>

        <div class="review-section">
            <h2>Daftar STA dalam Proyek Ini</h2>
            <ul id="sta-list-summary" class="sta-list">
                </ul>
        </div>

        <div class="review-section">
            <h2>Sketsa Profil Cross-Section (STA Terakhir)</h2>
            <canvas id="cross-section-plot"></canvas>
            <div id="review-points-table">
                </div>
        </div>

        <div class="btn-group">
            <button type="button" id="back-to-last-sta-edit">Kembali untuk Edit STA Terakhir</button>
            <button type="button" id="add-new-sta-btn" class="add-point-btn">Tambahkan STA Baru</button>
            <button type="button" id="export-project-csv-btn" class="btn-secondary">Unduh Proyek Lengkap (CSV)</button>
            <button type="button" id="export-project-json-btn" class="add-point-btn">Unduh Proyek Lengkap (JSON)</button>
            <button type="button" id="start-new-project-btn" class="add-point-btn">Mulai Proyek Baru</button>
            <button type="button" id="exit-btn" class="btn-secondary">Keluar Aplikasi</button>
        </div>
    </div>

    <template id="point-template">
        <div class="point-entry">
            <button type="button" class="remove-point-btn">Hapus Titik</button>
            <legend>Titik Target <span class="point-number">1</span></legend>
            <div class="form-group">
                <label>Nama Titik Target:</label>
                <input type="text" name="nama_titik" required>
            </div>
            <div class="form-group">
                <label>Jenis Observasi:</label>
                <select name="jenis_observasi">
                    <option value="BS">Backsight</option>
                    <option value="FS">Foresight</option>
                    <option value="IS">Intermediate Sight</option>
                </select>
            </div>
            <div class="form-group">
                <label>Bacaan Rambu:</label>
                <input type="number" name="bacaan_rambu" step="0.001" required>
            </div>
            <div class="form-group">
                <label>Elevasi Aktual:</label>
                <input type="text" name="elevasi_aktual" readonly>
            </div>
            <div class="form-group">
                <label>Offset:</label>
                <input type="number" name="offset" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Arah Offset:</label>
                <select name="arah_offset">
                    <option value="Kiri">Kiri</option>
                    <option value="Centerline (CL)">Centerline (CL)</option>
                    <option value="Kanan">Kanan</option>
                </select>
            </div>
            <div class="form-group">
                <label>Keterangan:</label>
                <input type="text" name="keterangan">
            </div>
        </div>
    </template>

    <script>
        // PWA: Daftarkan Service Worker
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', function() {
            navigator.serviceWorker.register('service-worker.js').then(function(registration) {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, function(err) {
              console.log('ServiceWorker registration failed: ', err);
            });
          });
        }

        // Ambil elemen-elemen halaman dan form
        const page1 = document.getElementById('page1');
        const page2 = document.getElementById('page2');
        const page3 = document.getElementById('page3');
        const page4 = document.getElementById('page4');
        
        const projectForm = document.getElementById('project-form');
        const staForm = document.getElementById('sta-form');
        const pointsForm = document.getElementById('points-form');
        const pointsContainer = document.getElementById('points-container');
        
        const backToPage1Btn = document.getElementById('back-to-page1');
        const backToPage2Btn = document.getElementById('back-to-page2');
        const backToLastStaEditBtn = document.getElementById('back-to-last-sta-edit'); 
        const addPointBtn = document.getElementById('add-point-btn');
        const saveStaBtn = document.getElementById('save-sta-btn'); 
        const addNewStaBtn = document.getElementById('add-new-sta-btn'); 
        const exportProjectCsvBtn = document.getElementById('export-project-csv-btn'); 
        const exportProjectJsonBtn = document.getElementById('export-project-json-btn'); 
        const startNewProjectBtn = document.getElementById('start-new-project-btn'); 
        const exitBtn = document.getElementById('exit-btn');
        
        const loadDataFile = document.getElementById('load-data-file');
        
        const pointTemplate = document.getElementById('point-template');

        const elevasiBmTtpInput = document.getElementById('elevasi_bm_ttp');
        const bsInput = document.getElementById('bs');
        const calculatedHiInput = document.getElementById('calculated_hi');

        const currentStaNameSpan = document.getElementById('current-sta-name'); 
        const reviewProjectName = document.getElementById('review-project-name'); 
        const staListSummary = document.getElementById('sta-list-summary'); 
        const reviewPointsTable = document.getElementById('review-points-table');
        const plotCanvas = document.getElementById('cross-section-plot');

        // --- GLOBAL DATA & STATE ---
        let allData = {
            project: {},
            stas: []
        };
        let calculatedHI = 0;
        let currentStaIndex = -1; // To track which STA is being edited/added

        // --- HELPER FUNCTIONS ---

        function calculateHI() {
            const elevasiBmTtp = parseFloat(elevasiBmTtpInput.value) || 0;
            const bs = parseFloat(bsInput.value) || 0;
            
            calculatedHI = elevasiBmTtp + bs;
            calculatedHiInput.value = calculatedHI.toFixed(3);
        }

        function calculateElevasiAktual(bacaanRambuInput, elevasiAktualInput) {
            const bacaanRambu = parseFloat(bacaanRambuInput.value) || 0;
            const elevasiAktual = calculatedHI - bacaanRambu;
            elevasiAktualInput.value = elevasiAktual.toFixed(3);
        }

        function addPointEntry(pointData = null) {
            const newPoint = pointTemplate.content.cloneNode(true);
            const pointEntryDiv = newPoint.querySelector('.point-entry');
            const pointNumberSpan = newPoint.querySelector('.point-number');
            const removeBtn = newPoint.querySelector('.remove-point-btn');

            const currentPointCount = pointsContainer.children.length;
            pointNumberSpan.textContent = currentPointCount + 1; // Update immediately
            
            const bacaanRambuInput = newPoint.querySelector('input[name="bacaan_rambu"]');
            const elevasiAktualInput = newPoint.querySelector('input[name="elevasi_aktual"]');
            
            bacaanRambuInput.addEventListener('input', () => {
                calculateElevasiAktual(bacaanRambuInput, elevasiAktualInput);
            });

            removeBtn.addEventListener('click', () => {
                pointsContainer.removeChild(pointEntryDiv);
                updatePointNumbers(); // Recalculate numbers after removal
            });
            
            if (pointData) {
                newPoint.querySelector('input[name="nama_titik"]').value = pointData.nama_titik;
                newPoint.querySelector('select[name="jenis_observasi"]').value = pointData.jenis_observasi;
                newPoint.querySelector('input[name="bacaan_rambu"]').value = pointData.bacaan_rambu;
                newPoint.querySelector('input[name="offset"]').value = pointData.offset;
                newPoint.querySelector('select[name="arah_offset"]').value = pointData.arah_offset;
                newPoint.querySelector('input[name="keterangan"]').value = pointData.keterangan;
                
                // Calculate elevasi aktual for loaded data, ensuring HI is set
                // This needs to be done AFTER HI is calculated if loading STA
                if (calculatedHI !== 0) { // Only calculate if HI is already determined
                    const elevasiAktual = calculatedHI - parseFloat(pointData.bacaan_rambu);
                    elevasiAktualInput.value = elevasiAktual.toFixed(3);
                }
            }

            pointsContainer.appendChild(newPoint);
            updatePointNumbers(); // Update numbers after adding
        }

        function updatePointNumbers() {
            Array.from(pointsContainer.children).forEach((entry, index) => {
                entry.querySelector('.point-number').textContent = index + 1;
            });
        }

        function fillForm(form, data) {
            for (const key in data) {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    input.value = data[key];
                }
            }
        }
        
        function serializeFormData(form) {
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            return data;
        }

        function displayProjectSummary() {
            reviewProjectName.textContent = allData.project.item_pekerjaan || allData.project.lokasi_proyek || 'Proyek Tanpa Nama';
            
            staListSummary.innerHTML = ''; // Clear previous list
            if (allData.stas.length === 0) {
                staListSummary.innerHTML = '<li>Belum ada STA yang ditambahkan.</li>';
                plotCanvas.getContext('2d').clearRect(0, 0, plotCanvas.width, plotCanvas.height);
                reviewPointsTable.innerHTML = 'Tidak ada data titik untuk ditampilkan.';
                return;
            }

            allData.stas.forEach((staEntry, index) => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <span>STA: ${staEntry.sta.titik_berdiri_alat_sta || 'N/A'} (HI: ${parseFloat(staEntry.sta.calculated_hi).toFixed(3) || 'N/A'})</span>
                    <button type="button" data-sta-index="${index}" class="btn-secondary view-sta-details">Lihat Detail</button>
                `;
                staListSummary.appendChild(listItem);
            });

            // Add event listeners for "Lihat Detail" buttons
            document.querySelectorAll('.view-sta-details').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.dataset.staIndex);
                    displayDetailedSta(allData.stas[index]);
                });
            });

            // Display details for the last STA by default
            displayDetailedSta(allData.stas[allData.stas.length - 1]);
        }

        function displayDetailedSta(staEntry) {
            let tableHtml = `
                <h3>Detail Titik Target STA: ${staEntry.sta.titik_berdiri_alat_sta}</h3>
                <table>
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>Titik</th>
                            <th>Jenis Obs.</th>
                            <th>Bacaan Rambu</th>
                            <th>Offset</th>
                            <th>Arah Offset</th>
                            <th>Elevasi Aktual</th>
                            <th>Keterangan</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            staEntry.points.forEach((point, index) => {
                tableHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${point.nama_titik}</td>
                        <td>${point.jenis_observasi}</td>
                        <td>${point.bacaan_rambu}</td>
                        <td>${point.offset}</td>
                        <td>${point.arah_offset}</td>
                        <td>${point.elevasi_aktual}</td>
                        <td>${point.keterangan}</td>
                    </tr>
                `;
            });
            tableHtml += `</tbody></table>`;
            reviewPointsTable.innerHTML = tableHtml;
            drawPlot(staEntry.points, parseFloat(staEntry.sta.calculated_hi)); // Pass HI for plotting
        }
        
        function drawPlot(pointsData, hiForPlot) {
            const ctx = plotCanvas.getContext('2d');
            ctx.clearRect(0, 0, plotCanvas.width, plotCanvas.height);
            if (!pointsData || pointsData.length === 0) {
                ctx.fillText('Tidak ada data titik untuk diplot.', 10, 20);
                return;
            }

            // Ensure elevations are calculated if not already (e.g., after loading)
            pointsData.forEach(point => {
                if (!point.elevasi_aktual && point.bacaan_rambu && hiForPlot !== 0) {
                     point.elevasi_aktual = (hiForPlot - parseFloat(point.bacaan_rambu)).toFixed(3);
                }
            });

            const sortedPoints = [...pointsData].sort((a, b) => parseFloat(a.offset) - parseFloat(b.offset));
            
            const offsets = sortedPoints.map(p => parseFloat(p.offset));
            const elevations = sortedPoints.map(p => parseFloat(p.elevasi_aktual));
            
            const minOffset = Math.min(...offsets);
            const maxOffset = Math.max(...offsets);
            const minElevation = Math.min(...elevations);
            const maxElevation = Math.max(...elevations);

            const padding = 30;
            const plotWidth = plotCanvas.width - 2 * padding;
            const plotHeight = plotCanvas.height - 2 * padding;

            function scaleX(offset) {
                if (maxOffset - minOffset === 0) {
                    return plotWidth / 2 + padding;
                }
                return padding + ((offset - minOffset) / (maxOffset - minOffset)) * plotWidth;
            }

            function scaleY(elevation) {
                if (maxElevation - minElevation === 0) {
                    return plotHeight / 2 + padding;
                }
                // Invert Y axis for plot: higher elevation means higher on screen
                return plotHeight - ((elevation - minElevation) / (maxElevation - minElevation)) * plotHeight + padding;
            }

            ctx.beginPath();
            ctx.strokeStyle = '#007bff';
            ctx.lineWidth = 2;
            ctx.moveTo(scaleX(offsets[0]), scaleY(elevations[0]));
            for (let i = 1; i < offsets.length; i++) {
                ctx.lineTo(scaleX(offsets[i]), scaleY(elevations[i]));
            }
            ctx.stroke();

            for (let i = 0; i < offsets.length; i++) {
                ctx.beginPath();
                ctx.arc(scaleX(offsets[i]), scaleY(elevations[i]), 4, 0, 2 * Math.PI);
                ctx.fillStyle = 'red';
                ctx.fill();
            }

            ctx.font = '10px Arial';
            ctx.fillStyle = '#333';
            ctx.textAlign = 'center';
            ctx.fillText('Offset', plotCanvas.width / 2, plotCanvas.height - 10);
            ctx.textAlign = 'left';
            ctx.fillText('Elevasi', 10, 20);
        }
        
        function formatTanggal(dateString) {
            // dateString is YYYY-MM-DD
            const parts = dateString.split('-');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1]}-${parts[0]}`; // DD-MM-YYYY
            }
            return dateString; // Fallback if format is unexpected
        }

        function generateProjectFilename(extension) {
            const surveyor = allData.project.surveyor.replace(/[^a-zA-Z0-9]/g, '_'); // Sanitize filename
            const location = allData.project.lokasi_proyek.replace(/[^a-zA-Z0-9]/g, '_');
            const formattedDate = formatTanggal(allData.project.tanggal_pengukuran); // Use formatted date
            return `${surveyor}_${location}_${formattedDate}.${extension}`;
        }

        function exportFullProjectToCSV() {
            if (!allData.stas || allData.stas.length === 0) {
                alert('Tidak ada data proyek untuk diekspor!');
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Project Information Header
            csvContent += "INFORMASI PROYEK,,\n";
            csvContent += `Surveyor,${allData.project.surveyor},\n`;
            csvContent += `Tanggal Pengukuran,${formatTanggal(allData.project.tanggal_pengukuran)},\n`; // Use formatted date
            csvContent += `Lokasi Proyek,${allData.project.lokasi_proyek},\n`;
            csvContent += `Item Pekerjaan/Area,${allData.project.item_pekerjaan},\n`;
            csvContent += `Kondisi Cuaca,${allData.project.kondisi_cuaca},\n\n`;

            allData.stas.forEach((staEntry, staIndex) => {
                // STA Information Header
                csvContent += `INFORMASI STA ${staIndex + 1},,\n`;
                csvContent += `Alat Waterpass,${staEntry.sta.alat_waterpass},\n`;
                csvContent += `Nomor Seri Alat,${staEntry.sta.nomor_seri_alat},\n`;
                csvContent += `Titik Berdiri Alat (STA),${staEntry.sta.titik_berdiri_alat_sta},\n`;
                csvContent += `BM/TTP,${staEntry.sta.bm_ttp},\n`;
                csvContent += `Bacaan Rambu BS,${staEntry.sta.bs},\n`;
                csvContent += `Elevasi BM/TTP,${staEntry.sta.elevasi_bm_ttp},\n`;
                csvContent += `Calculated HI,${staEntry.sta.calculated_hi},\n\n`;

                // Points Table Header for this STA
                csvContent += `DATA TITIK STA ${staIndex + 1},,,,,,\n`;
                csvContent += 'No,Nama Titik,Jenis Observasi,Bacaan Rambu,Elevasi Aktual,Offset,Arah Offset,Keterangan\n';

                // Points Data for this STA
                staEntry.points.forEach((point, pointIndex) => {
                    const row = `${pointIndex + 1},${point.nama_titik},${point.jenis_observasi},${point.bacaan_rambu},${point.elevasi_aktual},${point.offset},${point.arah_offset},${point.keterangan}\n`;
                    csvContent += row;
                });
                csvContent += '\n'; // Add a blank line between STAs for readability
            });

            const filename = generateProjectFilename('csv');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Data proyek lengkap berhasil diunduh dalam format CSV!');
        }

        function exportFullProjectToJSON() {
            if (!allData.stas || allData.stas.length === 0) {
                alert('Tidak ada data proyek untuk diekspor!');
                return;
            }

            const dataToSave = JSON.stringify(allData, null, 2);
            const filename = generateProjectFilename('json');
            const blob = new Blob([dataToSave], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            
            alert('Data proyek lengkap berhasil diunduh dalam format JSON!');
        }


        function resetForms() {
            projectForm.reset();
            staForm.reset();
            pointsContainer.innerHTML = '';
            // Don't add a default point when starting new project, only when starting new STA
            allData = { project: {}, stas: [] };
            calculatedHI = 0;
            calculatedHiInput.value = '';
            currentStaIndex = -1;
            saveAllDataToLocalStorage();
        }

        function startNewProject() {
            resetForms();
            page4.classList.add('hidden');
            page1.classList.remove('hidden');
        }

        function exitApplication() {
            alert('Untuk keluar dari aplikasi, silakan tutup jendela ini secara manual.');
        }

        function saveAllDataToLocalStorage() {
            try {
                localStorage.setItem('pengukuran_project_data', JSON.stringify(allData));
                console.log('Project data saved to Local Storage.');
            } catch (e) {
                console.error('Failed to save data to Local Storage:', e);
                alert('Gagal menyimpan data ke penyimpanan lokal. Pastikan ruang penyimpanan tersedia.');
            }
        }

        function loadAllDataFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('pengukuran_project_data');
                if (savedData) {
                    allData = JSON.parse(savedData);
                    console.log('Project data loaded from Local Storage.');
                    
                    // Check if project data exists
                    if (allData.project && Object.keys(allData.project).length > 0) {
                        fillForm(projectForm, allData.project); // Fill project form regardless
                        
                        // If STAs exist, go to review page
                        if (allData.stas && allData.stas.length > 0) {
                            displayProjectSummary();
                            page1.classList.add('hidden');
                            page4.classList.remove('hidden');
                            alert('Proyek Anda sebelumnya berhasil dimuat dari penyimpanan lokal. Anda dapat melanjutkan atau mengunduh data.');
                        } else {
                            // If project data exists but no STAs, go to STA setup (Page 2)
                            page1.classList.add('hidden');
                            page2.classList.remove('hidden');
                            alert('Proyek Anda sebelumnya berhasil dimuat. Silakan mulai STA pertama.');
                        }
                    }
                }
            } catch (e) {
                console.error('Failed to load data from Local Storage:', e);
                alert('Gagal memuat data dari penyimpanan lokal. Data mungkin rusak atau tidak ada.');
            }
        }

        function loadDataFromFile() {
            const file = loadDataFile.files[0];
            if (!file) {
                alert('Pilih file JSON terlebih dahulu.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const loadedData = JSON.parse(event.target.result);
                    // Validate if it's a valid project structure
                    if (loadedData.project && loadedData.stas && Array.isArray(loadedData.stas)) {
                        allData = loadedData;
                        saveAllDataToLocalStorage(); // Save loaded data to local storage for persistence
                        
                        fillForm(projectForm, allData.project);
                        displayProjectSummary();
                        
                        page1.classList.add('hidden');
                        page4.classList.remove('hidden');
                        alert('Data proyek lengkap berhasil dimuat dari file. Anda sekarang dapat melanjutkan atau mengunduh data.');
                        
                    } else {
                        alert('Format file JSON tidak valid untuk proyek pengukuran ini.');
                    }
                } catch (e) {
                    alert('Gagal memuat file. Pastikan file yang Anda pilih adalah file JSON yang valid.');
                    console.error('File load error:', e);
                }
            };
            reader.readAsText(file);
            loadDataFile.value = ''; // Clear file input after loading
        }

        function loadStaForEdit(staEntry, index) {
            currentStaIndex = index;
            fillForm(staForm, staEntry.sta);
            // Calculate HI for the loaded STA
            calculatedHI = parseFloat(staEntry.sta.calculated_hi); // Ensure HI is correctly set from loaded data
            calculatedHiInput.value = calculatedHI.toFixed(3); // Update display

            pointsContainer.innerHTML = ''; // Clear existing points
            staEntry.points.forEach(point => addPointEntry(point)); // Add points, calculating actual elevations

            currentStaNameSpan.textContent = staEntry.sta.titik_berdiri_alat_sta;
            page4.classList.add('hidden');
            page3.classList.remove('hidden');
            alert('STA ' + staEntry.sta.titik_berdiri_alat_sta + ' dimuat untuk diedit.');
        }

        // --- EVENT LISTENERS & NAVIGATION LOGIC ---
        
        // Initial load check for local storage data
        window.addEventListener('load', loadAllDataFromLocalStorage);

        // Page 1 (Project Info) -> Page 2 (STA Setup)
        projectForm.addEventListener('submit', function(event) {
            event.preventDefault();
            // Save project data when moving to STA setup
            allData.project = serializeFormData(projectForm);
            saveAllDataToLocalStorage();
            
            page1.classList.add('hidden');
            page2.classList.remove('hidden');
            
            // If starting a new STA after previously loading a project with STAs, clear staForm
            // This is handled by currentStaIndex = -1 when starting a new STA or new project
            if (currentStaIndex === -1 && Object.keys(staForm).length > 0) { // Check if staForm has values
                 staForm.reset();
                 pointsContainer.innerHTML = '';
                 calculatedHI = 0;
                 calculatedHiInput.value = '';
            } else {
                 calculateHI(); // Calculate HI initially for new STA or if editing an existing one
            }
        });
        
        // Page 2 (STA Setup) -> Page 1 (Project Info)
        backToPage1Btn.addEventListener('click', function() {
            page2.classList.add('hidden');
            page1.classList.remove('hidden');
        });
        
        // Page 2 (STA Setup) -> Page 3 (Input Titik Target)
        staForm.addEventListener('submit', function(event) {
            event.preventDefault();
            // The STA data is saved temporarily. It will be added to allData.stas on page3 submission
            
            // Set current STA name for display on Page 3
            currentStaNameSpan.textContent = staForm.titik_berdiri_alat_sta.value;

            page2.classList.add('hidden');
            page3.classList.remove('hidden');
            
            // If it's a new STA or no points are currently loaded, add an empty point entry
            if (pointsContainer.children.length === 0) {
                addPointEntry();
            }
        });
        
        // Page 3 (Input Titik Target) -> Page 2 (STA Setup)
        backToPage2Btn.addEventListener('click', function() {
            page3.classList.add('hidden');
            page2.classList.remove('hidden');
        });
        
        // Page 4 (Review) -> Page 3 (Input Titik Target - last STA)
        backToLastStaEditBtn.addEventListener('click', function() {
            if (allData.stas.length > 0) {
                const lastStaIndex = allData.stas.length - 1;
                loadStaForEdit(allData.stas[lastStaIndex], lastStaIndex);
            } else {
                alert('Tidak ada STA untuk diedit. Memulai STA baru.');
                staForm.reset();
                pointsContainer.innerHTML = '';
                addPointEntry(); // Add first point for new STA
                calculatedHI = 0;
                calculatedHiInput.value = '';
                currentStaIndex = -1;
                page4.classList.add('hidden');
                page2.classList.remove('hidden');
            }
        });
        
        // Add event listener for "Tambah Titik"
        addPointBtn.addEventListener('click', addPointEntry);
        
        // Event listener for "Muat Data" file input
        loadDataFile.addEventListener('change', loadDataFromFile);

        // Recalculate HI on input change
        elevasiBmTtpInput.addEventListener('input', calculateHI);
        bsInput.addEventListener('input', calculateHI);
    
        // Logika Page 3 (Input Titik Target) -> Page 4 (Review Project Summary)
        saveStaBtn.addEventListener('click', function(event) { 
            event.preventDefault();
            
            const staData = serializeFormData(staForm);
            const pointsData = Array.from(pointsContainer.querySelectorAll('.point-entry')).map(pointEntry => {
                const pointData = {};
                const inputs = pointEntry.querySelectorAll('input, select');
                inputs.forEach(input => {
                    pointData[input.name] = input.value;
                });
                return pointData;
            });
            
            const currentStaEntry = { sta: staData, points: pointsData };

            if (currentStaIndex === -1) { // New STA
                allData.stas.push(currentStaEntry);
            } else { // Editing existing STA
                allData.stas[currentStaIndex] = currentStaEntry;
                currentStaIndex = -1; // Reset after editing
            }
            
            saveAllDataToLocalStorage(); // Save updated allData
            displayProjectSummary(); // Update summary on Page 4
            
            page3.classList.add('hidden');
            page4.classList.remove('hidden');
        });
        
        // Logika untuk tombol "Unduh Proyek Lengkap (JSON)"
        exportProjectJsonBtn.addEventListener('click', exportFullProjectToJSON);
        
        // Logika untuk tombol "Unduh Proyek Lengkap (CSV)"
        exportProjectCsvBtn.addEventListener('click', exportFullProjectToCSV);

        // Logika untuk tombol "Tambahkan STA Baru"
        addNewStaBtn.addEventListener('click', function() {
            staForm.reset();
            pointsContainer.innerHTML = '';
            addPointEntry(); // Add first point for new STA
            calculatedHI = 0;
            calculatedHiInput.value = '';
            currentStaIndex = -1; // Indicate new STA creation
            page4.classList.add('hidden');
            page2.classList.remove('hidden'); // Go back to STA Setup
        });

        // Logika untuk tombol "Mulai Proyek Baru"
        startNewProjectBtn.addEventListener('click', startNewProject);

        // Logika untuk tombol "Keluar Aplikasi"
        exitBtn.addEventListener('click', exitApplication);
    </script>
</body>
</html>